---
title: "fitbit analysis for CSEP project"
author: "Shelby Sturrock"
date: "14/01/2022"
output: 
  html_document:
    keep_md: true
---

```{r setup, include=FALSE, results=FALSE, echo=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(tidyr)
knitr::opts_knit$set(root.dir = '~/Desktop/CSEP fitbit')
```

## processing FitBit data 

### read in data from three time periods: 

```{r, results="hide"}

# nov 08 - nov 21
  nov08<-list.files("fitbit_data/nov08-nov21", pattern="*.csv", full.names=TRUE)
  nov08_csv<-lapply(nov08, read.csv)
  names(nov08_csv)<-paste(gsub("fitbit_data/nov08-nov21/|.csv","",nov08),".1",sep="")
  list2env(nov08_csv,envir=.GlobalEnv)
  rm(nov08,nov08_csv)
  
# nov 22 - dec 05
  nov22<-list.files("fitbit_data/nov22-dec05", pattern="*.csv", full.names=TRUE)
  nov22_csv<-lapply(nov22, read.csv)
  names(nov22_csv)<-paste(gsub("fitbit_data/nov22-dec05/|.csv","",nov22),".2",sep="")
  list2env(nov22_csv,envir=.GlobalEnv)
  rm(nov22,nov22_csv)

# dec 06 - dec 12
  dec06<-list.files("fitbit_data/dec06-dec12", pattern="*.csv", full.names=TRUE)
  dec06_csv<-lapply(dec06, read.csv)
  names(dec06_csv)<-paste(gsub("fitbit_data/dec06-dec12/|.csv","",dec06),".3",sep="")
  list2env(dec06_csv,envir=.GlobalEnv)
  rm(dec06,dec06_csv)
    
```

### for each unique data type/dataset, consolidate data from three time periods

```{r}

# generate list of unique datasets (there are 18)
  files<-unique(gsub("\\.1|\\.2|\\.3","",ls()))
    
# for each unique type of data, rbind data from the three periods together
  for(i in 1:length(files)) {
      
      pattern<-files[i]
      X<-mget(ls(pattern=pattern)) %>% bind_rows()
      assign(gsub("_merged","",pattern),X)
      rm(list = ls()[grepl(pattern, ls())])
      rm(X)
      i<-i+1
      
    }
    
# clean environment
  rm(i,pattern,files)
    
```

#### leaves a total of 18 unique dataframes

```{r}
  ls()
```

## minute-level data

### explore minute-level data (note date/time variable is "ActivityMinute" in most but not all dataframes)

#### minute-level step count

```{r}
  str(minuteStepsNarrow) # steps per minute
```

#### minute-level calories

```{r}
  str(minuteCaloriesNarrow) # calories burned each minute
```

#### minute-level activity intensity

```{r}
  str(minuteIntensitiesNarrow) # intensity of activity during each minute -- 0, 1, 2 and 3
```

#### minute-level METs

```{r}
  str(minuteMETsNarrow) # MET value measued each minute
```

#### minute-level heart rate (fewer observations than above)

```{r}
  str(heartrate_1min) # heart rate measured each minute -- fewer measurements than above
```

#### minute-level sleep stages 

```{r}
  str(minuteSleep) # sleep stage per minute?
```

#### 30 second sleep stages

```{r}
  str(`30secondSleepStages`) # sleep stages per 30 seconds? -- also fewer sleep observations
```


### process minute-level data

#### merge minute-level calories, intensities, METs and steps

```{r}
  minute <- minuteCaloriesNarrow %>% full_join(minuteIntensitiesNarrow, by = c("ActivityMinute","Id")) %>%
                                     full_join(minuteMETsNarrow, by = c("ActivityMinute","Id")) %>%
                                     full_join(minuteStepsNarrow, by = c("ActivityMinute","Id")) 
  rm(minuteCaloriesNarrow,minuteIntensitiesNarrow,minuteMETsNarrow,minuteStepsNarrow)
```

#### generate dateTime and date variables with common naming convention 

```{r}
  minute$dateTime<-lubridate::mdy_hms(minute$ActivityMinute)
  minute$date<-as.Date(minute$dateTime)
  min(minute$date)
  max(minute$date)
```

### clean and explore minute-level sleep data

#### issue: sleep observations can be measured on the half or full minute

```{r}

# sleep observations can be measured on the half or full minute (one or the other within a given bout of sleep)
  minuteSleep$test1<-ifelse(grepl(":30 ",minuteSleep$date),":30",":00")
  table(minuteSleep$test1)
  
  
# all other minute-level data is measured on the full minute
  minute$test1<-ifelse(grepl(":30 ",minute$dateTime),":30",":00")
  table(minute$test1)
  
```

#### solution: update the date all observations fall on the full minute (to align with other minute-level data)

```{r}

# since sleep is either measured at :00 or :30 within a bout of sleep,
# we can update all records to ":00 " without introducing any duplicates
# this is necessary to merge sleep records with the other minute-level data (always measured on full minute)
  minuteSleep$date<-gsub(":30 ",":00 ",minuteSleep$date)
  minuteSleep$dateTime<-lubridate::mdy_hms(minuteSleep$date)
  minuteSleep$date<-as.Date(minuteSleep$dateTime)
  minuteSleep$test2<-ifelse(grepl(":30 ",minuteSleep$date),":30",":00")
  table(minuteSleep$test2)
  
```


#### filter minute-level sleep data to to same time range as other data types

```{r}

  min(minuteSleep$date) # data from 2021-11-07 but other data types start 2021-11-08
  max(minuteSleep$date) # data from 2021-12-13, but other data types end 2021-12-12
  minuteSleep<-minuteSleep[minuteSleep$date>"2021-11-08" & minuteSleep$date<"2021-12-13",]

```


#### issue: there are duplicate sleep records for most participants

```{r}

  test<-minuteSleep %>% select(Id,dateTime) %>% group_by(Id,dateTime) %>% mutate(length=length(Id))
  table(test$length) # this is unrelated to updating the date/time from :30 to :00 above
  length(unique(test[test$length==2,]$Id)) # almost every participant has duplicate records for sleep
  
```

#### note: all but 6 observations (3 minutes for 1 participants) are exact duplicates (same Id, date AND value)

```{r}

  test3<-minuteSleep %>% select(Id,dateTime,value) %>% group_by(Id,dateTime) %>% 
                                                       mutate(length=length(Id)) %>%
                                                       mutate(unique=length(unique(value)))

# however, only 6 records (3 minutes for 1 participant) have more than one unique "value" within the same minute
# the rest of the duplicate rows are exact duplicates (same "value" (sleep stage) across both observations)
  table(test3[test3$length==2,]$unique) 
  rm(test,test3)

```


#### solution: remove duplicate records within the minute-level sleep data

```{r}

# create de-duplicated version of the minuteSleep dataframe
# need to decide how to handle the 3 minutes with two unique "values"
  minuteSleep<-minuteSleep %>% select(-test1,-test2)
  minuteSleep<-distinct(minuteSleep) 
  test4<-minuteSleep %>% select(Id,dateTime,value) %>% group_by(Id,dateTime) %>% 
                                                       mutate(length=length(Id)) %>%
                                                       mutate(unique=length(unique(value)))
  table(test4$length)

# 1 participant has 800+ rows that are duplicates but the logId differs
  minuteSleep<-distinct(minuteSleep, across(-"logId"),.keep_all = TRUE) 
  test4<-minuteSleep %>% select(Id,dateTime,value) %>% group_by(Id,dateTime) %>% 
                                                       mutate(length=length(Id)) %>%
                                                       mutate(unique=length(unique(value)))
  table(test4$length)
  rm(test4)
  
# decide what to do with duplicate records with differing "values"
  
```


### merge minute-level sleep with other minute-level data

```{r}
  minute <- minute %>% full_join(minuteSleep, by = c("dateTime","Id"))
  rm(minuteSleep)
```

## day-level data

### explore day-level data

#### day-level calories

```{r}
  str(dailyCalories)
```

#### day-level intensities

```{r}
  str(dailyIntensities)
```

#### day-level steps

```{r}
  str(dailySteps)
```

#### day-level sleep 

```{r}
  str(sleepDay)
```

#### day-level sleep stages

```{r}
  str(sleepStagesDay) # same variables as above (Id, SleepDay, TotalSleepRecords, TotalMinutesAsleep, TotalTimeInBed) plus total minutes awake and spent in each sleep stage (light/deep/REM)
```

### merge day-level activity data

```{r}
  daily<-dailyCalories %>% full_join(dailyIntensities, by = c("ActivityDay","Id")) %>%
                           full_join(dailySteps, by = c("ActivityDay","Id")) 
  rm(dailyCalories,dailyIntensities,dailySteps)
```

#### generate date variable (named to align with date column in minute-level datasets)

```{r}
  str(daily$ActivityDay)
  daily$date<-as.Date(daily$ActivityDay,"%m/%d/%Y")
```

### merge day-level activity data and day-level sleep data 

#### generate date in the day-level sleep data 

```{r}
  sleepStagesDay$date<-as.Date(lubridate::mdy_hms(sleepStagesDay$SleepDay))
```

#### merge day-level activity data and day-level sleep data

```{r}
  daily<-daily %>% full_join(sleepStagesDay, by = c("date","Id"))
  daily<-daily %>% select(-ActivityDay,-SleepDay)
```




