---
title: "fitbit analysis for CSEP project"
author: "Shelby Sturrock"
date: "14/01/2022"
output: 
  html_document:
    keep_md: true
---

```{r setup, include=FALSE, results=FALSE, echo=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(tidyr)
knitr::opts_knit$set(root.dir = '~/Desktop/CSEP fitbit')
```

## processing FitBit data 

### read in data from three time periods: 

```{r, results="hide"}

  # nov 08 - nov 21
    nov08<-list.files("fitbit_data/nov08-nov21", pattern="*.csv", full.names=TRUE)
    nov08_csv<-lapply(nov08, read.csv)
    names(nov08_csv)<-paste(gsub("fitbit_data/nov08-nov21/|.csv","",nov08),".1",sep="")
    list2env(nov08_csv,envir=.GlobalEnv)
    rm(nov08,nov08_csv)
    
  # nov 22 - dec 05
    nov22<-list.files("fitbit_data/nov22-dec05", pattern="*.csv", full.names=TRUE)
    nov22_csv<-lapply(nov22, read.csv)
    names(nov22_csv)<-paste(gsub("fitbit_data/nov22-dec05/|.csv","",nov22),".2",sep="")
    list2env(nov22_csv,envir=.GlobalEnv)
    rm(nov22,nov22_csv)
  
  # dec 06 - dec 12
    dec06<-list.files("fitbit_data/dec06-dec12", pattern="*.csv", full.names=TRUE)
    dec06_csv<-lapply(dec06, read.csv)
    names(dec06_csv)<-paste(gsub("fitbit_data/dec06-dec12/|.csv","",dec06),".3",sep="")
    list2env(dec06_csv,envir=.GlobalEnv)
    rm(dec06,dec06_csv)
    
```

### for each unique data type/dataset, consolidate data from three time periods

```{r}

# generate list of unique datasets (there are 18)
    files<-unique(gsub("\\.1|\\.2|\\.3","",ls()))
    
  # for each unique type of data, rbind data from the three periods together
    for(i in 1:length(files)) {
      
      pattern<-files[i]
      X<-mget(ls(pattern=pattern)) %>% bind_rows()
      assign(gsub("_merged","",pattern),X)
      rm(list = ls()[grepl(pattern, ls())])
      rm(X)
      i<-i+1
      
    }
    
  # clean environment
    rm(i,pattern,files)
    
```

#### leaves a total of 18 unique dataframes

```{r}
    ls()
```

### explore minute-level data (note date/time variable is "ActivityMinute" in most but not all dataframes)

#### minute-level step count

```{r}
      str(minuteStepsNarrow) # steps per minute
```

#### minute-level calories

```{r}
      str(minuteCaloriesNarrow) # calories burned each minute
```

#### minute-level activity intensity

```{r}
      str(minuteIntensitiesNarrow) # intensity of activity during each minute -- 0, 1, 2 and 3
```

#### minute-level METs

```{r}
      str(minuteMETsNarrow) # MET value measued each minute
```

#### minute-level heart rate (fewer observations than above)

```{r}
      str(heartrate_1min) # heart rate measured each minute -- fewer measurements than above
```

#### minute-level sleep stages 

```{r}
      str(minuteSleep) # sleep stage per minute?
```

#### 30 second sleep stages

```{r}
      str(`30secondSleepStages`) # sleep stages per 30 seconds? -- also fewer sleep observations
```


### process minute-level data

#### merge minute-level calories, intensities, METs and steps

```{r}
    minute <- minuteCaloriesNarrow %>% full_join(minuteIntensitiesNarrow, by = c("ActivityMinute","Id")) %>%
                                       full_join(minuteMETsNarrow, by = c("ActivityMinute","Id")) %>%
                                       full_join(minuteStepsNarrow, by = c("ActivityMinute","Id")) 
```

#### generate dateTime and date variables with common naming convention 

```{r}
    minute$dateTime<-lubridate::mdy_hms(minute$ActivityMinute)
    minute$date<-as.Date(minute$dateTime)
```

#### clean and rename the date/time variable in the minute-level sleep data 

```{r}
# note: sleep observations are occasionally measured on the half minute, while all other data are consistently measured on the full minute. I investigated and sleep metrics are reported on either the half or the full minute within a given bout of sleep. As such, you can update the second value from ":30 " to ":00 " without introducing any duplciate records. This is necessary to merge these sleep records with the other minute-level dataframe 

    minuteSleep$date<-gsub(":30 ",":00 ",minuteSleep$date)
    minuteSleep$dateTime<-lubridate::mdy_hms(minuteSleep$date)
    
```







